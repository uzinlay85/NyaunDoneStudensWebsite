<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ညောင်းတုန်းကျောင်းတိုက် သံဃာတော်များ</title>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.cdnfonts.com/css/padauk');
        body {
            font-family: 'Padauk', sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .total-count {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .copy-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .copy-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container mx-auto">
        <h1 class="text-2xl font-bold mb-4">၁၃၈၇-၂၀၂၅-ခုနှစ် ပါဠိတက္ကသိုလ်ညောင်တုန်းကျောင်းတိုက် သံဃာစာရင်း</h1>
        <div id="totalCount" class="total-count"></div>
        <!-- Filters -->
        <div class="mb-4">
            <select id="classFilter" class="border p-2 mr-2" onChange="applyFilters()">
                <option value="">အတန်းကို ရွေးပါ</option>
            </select>
            <select id="schoolFilter" class="border p-2 mr-2" onChange="applyFilters()">
                <option value="">ကျောင်းကို ရွေးပါ</option>
            </select>
            <select id="subjectCountFilter" class="border p-2 mr-2" onChange="applyFilters()">
                <option value="">ဘာသာရပ်အရေအတွက်</option>
                <option value="4">၄ ဘာသာရပ်</option>
                <option value="3">၃ ဘာသာရပ်</option>
                <option value="2">၂ ဘာသာရပ်</option>
                <option value="1">၁ ဘာသာရပ်</option>
                <option value="custom">စိတ်ကြိုက်</option>
            </select>
            <select id="customSubjectFilter" class="border p-2" style="display:none;" onChange="applyFilters()">
                <option value="">ဘာသာရပ်ကို ရွေးပါ</option>
                <option value="P">ပါ</option>
                <option value="TH">သီ</option>
                <option value="N">ဏီ</option>
                <option value="O">သစ်/ဟောင်း</option>
            </select>
        </div>
        <table id="studentTable">
            <thead>
                <tr>
                    <th>နံပါတ်စဉ်</th>
                    <th>နာမည်</th>
                    <th>အတန်း</th>
                    <th>ကျောင်း</th>
                    <th>ခုံနံပါတ်</th>
                    <th>ပါ</th>
                    <th>သီ</th>
                    <th>ဏီ</th>
                    <th>သစ်/ဟောင်း</th>
                </tr>
            </thead>
            <tbody id="studentBody"></tbody>
        </table>
        <div id="errorMessage" class="error"></div>
        <button id="copyButton" class="copy-button" onclick="copyTable()">စာရင်းကို ကူးယူမည်</button>
    </div>

    <script>
        let allData = [];

        const loadStudents = () => {
            const tableBody = document.getElementById('studentBody');
            const errorDiv = document.getElementById('errorMessage');
            const classFilter = document.getElementById('classFilter');
            const schoolFilter = document.getElementById('schoolFilter');
            const subjectCountFilter = document.getElementById('subjectCountFilter');
            const customSubjectFilter = document.getElementById('customSubjectFilter');

            fetch('students.csv')
                .then(response => response.text())
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (result) => {
                            allData = result.data.map(row => ({
                                Name: row.Name || '',
                                Class: row.Class || '',
                                School: row.School || '',
                                C_Num: row.C_Num || '',
                                P: row.P || '',
                                TH: row.TH || '',
                                N: row.N || '',
                                O: row.O || ''
                            }));

                            // Populate dropdowns with unique values
                            const uniqueClasses = [...new Set(allData.map(student => student.Class))].sort();
                            const uniqueSchools = [...new Set(allData.map(student => student.School))].sort();
                            uniqueClasses.forEach(cls => {
                                const option = document.createElement('option');
                                option.value = cls;
                                option.textContent = cls;
                                classFilter.appendChild(option);
                            });
                            uniqueSchools.forEach(school => {
                                const option = document.createElement('option');
                                option.value = school;
                                option.textContent = school;
                                schoolFilter.appendChild(option);
                            });

                            applyFilters();
                        },
                        error: (error) => {
                            errorDiv.textContent = `CSV ဖိုင်ဖွင့်ရာတွင် အမှားဖြစ်ပါတယ်: ${error.message}`;
                            console.error('CSV parsing error:', error);
                        }
                    });
                })
                .catch(error => {
                    errorDiv.textContent = `CSV ဖိုင်ကို မရှာနိုင်ပါ: ${error.message}`;
                    console.error('Fetch error:', error);
                });
        };

        const applyFilters = () => {
            const tableBody = document.getElementById('studentBody');
            const totalCount = document.getElementById('totalCount');
            const classFilter = document.getElementById('classFilter').value;
            const schoolFilter = document.getElementById('schoolFilter').value;
            const subjectCountFilter = document.getElementById('subjectCountFilter').value;
            const customSubjectFilter = document.getElementById('customSubjectFilter');
            const customSubjectValue = customSubjectFilter.value;

            const filteredData = allData.filter(student => {
                const subjectCount = [student.P, student.TH, student.N, student.O].filter(Boolean).length;
                let subjectMatch = true;

                if (subjectCountFilter === 'custom' && customSubjectValue) {
                    subjectMatch = student[customSubjectValue] !== '';
                } else if (subjectCountFilter && subjectCountFilter !== 'custom') {
                    const requiredCount = parseInt(subjectCountFilter);
                    subjectMatch = subjectCount === requiredCount;
                }

                return (!classFilter || student.Class === classFilter) &&
                       (!schoolFilter || student.School === schoolFilter) &&
                       subjectMatch;
            });

            // Count monks and novices
            const monksCount = filteredData.filter(student => !student.Name.startsWith('ရှင်')).length;
            const novicesCount = filteredData.filter(student => student.Name.startsWith('ရှင်')).length;

            totalCount.textContent = `ရွေးချယ်ထားသည့် သံဃာတော်အရေအတွက်: ${filteredData.length} ပါး၊ ရဟန်း (${monksCount}) ပါး၊ သာမဏေ (${novicesCount}) ပါး`;
            tableBody.innerHTML = '';
            // Sort by C_Num if classFilter is selected
            const sortedData = classFilter ? [...filteredData].sort((a, b) => {
                const numA = a.C_Num ? parseInt(a.C_Num) : Infinity;
                const numB = b.C_Num ? parseInt(b.C_Num) : Infinity;
                return numA - numB;
            }) : filteredData;

            sortedData.forEach((student, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.Name}</td>
                    <td>${student.Class}</td>
                    <td>${student.School}</td>
                    <td>${student.C_Num}</td>
                    <td>${student.P}</td>
                    <td>${student.TH}</td>
                    <td>${student.N}</td>
                    <td>${student.O}</td>
                `;
                tableBody.appendChild(row);
            });

            // Show/hide custom subject filter based on selection
            if (subjectCountFilter === 'custom') {
                customSubjectFilter.style.display = 'inline';
            } else {
                customSubjectFilter.style.display = 'none';
            }
        };

        const copyTable = () => {
            const table = document.getElementById('studentTable');
            const classFilter = document.getElementById('classFilter').value;
            const schoolFilter = document.getElementById('schoolFilter').value;
            const subjectCountFilter = document.getElementById('subjectCountFilter').value;
            const customSubjectFilter = document.getElementById('customSubjectFilter').value;
            const totalCountText = document.getElementById('totalCount').textContent;
            const totalCount = totalCountText.match(/\d+/)[0];
            const monksCount = totalCountText.match(/ရဟန်း \(\d+\)/)[0].match(/\d+/)[0];
            const novicesCount = totalCountText.match(/သာမဏေ \(\d+\)/)[0].match(/\d+/)[0];

            let text = '';
            // Custom header based on filters
            text += `၁-အတန်း: ${classFilter || 'မရွေးချယ်ရ'} | ကျောင်း: ${schoolFilter || 'မရွေးချယ်ရ'} | ဘာသာရပ်: ${subjectCountFilter === 'custom' ? customSubjectFilter : subjectCountFilter || 'မရွေးချယ်ရ'} | သံဃာတော် (${totalCount}) ပါး၊ ရဟန်း (${monksCount}) ပါး၊ သာမဏေ (${novicesCount}) ပါး\n`;
            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent).join('\t');
            text += headers + '\n';
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent);
                text += `${String(index + 1).padStart(2, '0')}-${cells.join('\t')}\n`;
            });
            navigator.clipboard.writeText(text)
                .then(() => alert('စာရင်းကို အောင်မြင်စွာ ကူးယူပြီးပါသည်!'))
                .catch(err => console.error('Copy failed:', err));
        };

        // Load data when page loads
        window.onload = loadStudents;
    </script>
</body>
</html>
